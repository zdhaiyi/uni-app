if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((n=>t.resolve(e()).then((()=>n))),(n=>t.resolve(e()).then((()=>{throw n}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e){return weex.requireModule(e)}function n(e,t,...n){uni.__log__?uni.__log__(e,t,...n):console[e].apply(console,[...n,t])}const a=(t,n=0)=>(n,a=e.getCurrentInstance())=>{!e.isInSSRComponentSetup&&e.injectHook(t,n,a)},s=a("onHide",3),o=a("onLaunch",1),i=(e,t)=>{const n=e.__vccOpts||e;for(const[a,s]of t)n[a]=s;return n},c=i({__name:"uni-icons",props:{type:{type:String,default:""},size:{type:[Number,String],default:32},color:{type:String,default:"#333"}},setup:t=>(n,a)=>(e.openBlock(),e.createElementBlock("view",{class:e.normalizeClass(["uni-icons",[t.type?"uni-icons-"+t.type:""]]),style:e.normalizeStyle({color:t.color,"font-size":t.size+"rpx"})},["compass"===t.type?(e.openBlock(),e.createElementBlock("text",{key:0},"🧭")):"chat"===t.type?(e.openBlock(),e.createElementBlock("text",{key:1},"💬")):"chatboxes"===t.type?(e.openBlock(),e.createElementBlock("text",{key:2},"📨")):"personadd"===t.type?(e.openBlock(),e.createElementBlock("text",{key:3},"👤")):"camera"===t.type?(e.openBlock(),e.createElementBlock("text",{key:4},"📷")):"person"===t.type?(e.openBlock(),e.createElementBlock("text",{key:5},"👥")):"game"===t.type?(e.openBlock(),e.createElementBlock("text",{key:6},"🎮")):"more"===t.type?(e.openBlock(),e.createElementBlock("text",{key:7},"⋯")):"refresh"===t.type?(e.openBlock(),e.createElementBlock("text",{key:8},"🔄")):(e.openBlock(),e.createElementBlock("text",{key:9},"❓"))],6))},[["__scopeId","data-v-8b6842e2"]]);const l=new class{constructor(){this.vpn=null,this.available=!1,this.inited=!1,this.isConnecting=!1,this.isConnected=!1,this.statusCb=null,this.timer=null,this.connectStartAt=0}_emit(e){if("function"==typeof this.statusCb)try{this.statusCb(e||{})}catch(t){n("error","at utils/android-vpn.js:20",t)}}async initialize(){if(this.inited)return this.available;try{if("android"!==uni.getSystemInfoSync().platform)return n("warn","at utils/android-vpn.js:32","[VPN] 非 Android 平台，跳过原生插件"),this.available=!1,this.inited=!0,!1;0,this.vpn=t("MyVpnPlugin"),this.available=!!this.vpn,this.available?"function"==typeof this.vpn.onVpnStatusUpdate&&this.vpn.onVpnStatusUpdate((e=>{const t=!(!e||!e.connected&&!e.isConnected),n=e&&(e.message||e.msg)||(t?"已连接":"未连接");this.isConnected=t,this.isConnecting=!1,this._emit({connected:t,status:t?"connected":"disconnected",message:n})})):n("warn","at utils/android-vpn.js:61","[VPN] 未加载到原生插件，将使用模拟模式")}catch(e){n("error","at utils/android-vpn.js:64","[VPN] 初始化失败：",e),this.available=!1}return this.inited=!0,this.available}onStatusUpdate(e){this.statusCb=e}offStatusUpdate(){this.statusCb=null}async getStatus(){if(this.inited||await this.initialize(),this.available&&"function"==typeof this.vpn.getVpnStatus)try{return await new Promise((e=>{this.vpn.getVpnStatus((t=>{const n=!(!t||!t.connected&&!t.isConnected);e({connected:n,status:n?"connected":"disconnected",message:t&&(t.message||t.msg)||(n?"已连接":"未连接")})}))}))}catch(e){}return{connected:this.isConnected,status:this.isConnected?"connected":this.isConnecting?"connecting":"disconnected",message:this.isConnected?"已连接":"未连接"}}async connect(e){if(this.inited||await this.initialize(),!e||!e.host||!e.port)throw new Error("节点信息不完整");if(this.isConnecting)throw new Error("连接中，请稍候");if(this.isConnected)throw new Error("已连接，请先断开");const t={proxyType:"socks5",server:e.host,port:parseInt(e.port,10)||1080,username:e.account||"",password:e.password||"",authType:e.account&&e.password?"password":"none"};return this.isConnecting=!0,this._emit({connected:!1,status:"connecting",message:"连接中..."}),this.available&&"function"==typeof this.vpn.startVpn?await new Promise(((e,n)=>{const a=setTimeout((()=>{this.isConnecting=!1,n(new Error("连接超时")),this._emit({connected:!1,status:"error",message:"连接超时"})}),3e4);try{this.vpn.startVpn(t,(t=>{clearTimeout(a),this.isConnecting=!1;const s=!(!t||!t.success);return this.isConnected=s,this.connectStartAt=s?Date.now():0,this._emit({connected:s,status:s?"connected":"error",message:t&&t.message||(s?"连接成功":"连接失败")}),s?e(t):n(new Error(t&&t.message||"连接失败"))}))}catch(s){clearTimeout(a),this.isConnecting=!1,this.isConnected=!1,this._emit({connected:!1,status:"error",message:s.message||"连接异常"}),n(s)}})):await this._mockConnect()}async disconnect(){return this.available&&"function"==typeof this.vpn.stopVpn?await new Promise((e=>{try{this.vpn.stopVpn((t=>{this.isConnected=!1,this.isConnecting=!1,this.connectStartAt=0,this._emit({connected:!1,status:"disconnected",message:t&&t.message||"已断开"}),e(t||{success:!0})}))}catch(t){this.isConnected=!1,this.isConnecting=!1,this.connectStartAt=0,this._emit({connected:!1,status:"disconnected",message:"已断开"}),e({success:!0})}})):(clearInterval(this.timer),this.timer=null,this.isConnected=!1,this.isConnecting=!1,this.connectStartAt=0,this._emit({connected:!1,status:"disconnected",message:"已断开（模拟）"}),{success:!0})}async _mockConnect(){return await new Promise((e=>{setTimeout((()=>{this.isConnecting=!1,this.isConnected=!0,this.connectStartAt=Date.now(),this._emit({connected:!0,status:"connected",message:"模拟连接成功"}),clearInterval(this.timer),this.timer=setInterval((()=>{this.isConnected&&this._emit({connected:!0,status:"connected",message:"模拟运行中"})}),3e3),e({success:!0,message:"模拟连接成功"})}),1e3)}))}},r=i({__name:"index",setup(t){const a=e.ref(!1),s=e.ref(""),o=e.ref(""),i=e.ref(!1),r=e.ref(!1),u=e.ref("未连接"),d=e.ref("--"),p=e.ref("--"),m=e.ref("连接VPN"),v=e.ref([]),h=e.ref(null),g=e.ref(1),y=e.ref(20),f=e.ref(!1);e.ref(!1);let w=null;const E=e.computed((()=>v.value.filter((e=>e.status&&!S(e))))),V=e.computed((()=>i.value?"connected":r.value?"connecting":"disconnected"));async function k(){if(a.value){if(!f.value){f.value=!0,uni.showLoading({title:"获取节点中..."});try{const e=await uni.request({url:"http://124.223.21.69/api/nodes",method:"GET",data:{page:g.value,pageSize:y.value},header:{Authorization:"Bearer "+o.value}});let t=[];Array.isArray(e.data)?t=e.data:e.data&&Array.isArray(e.data.nodes)?t=e.data.nodes:e.data&&Array.isArray(e.data.data)&&(t=e.data.data),v.value=(t||[]).map((e=>({...e})));const n=v.value.findIndex((e=>e.status&&!S(e)));h.value=-1!==n?n:v.value.length?0:null}catch(e){uni.showToast({title:"获取节点失败",icon:"none"}),n("error","at pages/index/index.vue:182",e)}finally{f.value=!1,uni.hideLoading()}}}else uni.showToast({title:"请先登录",icon:"none"})}function S(e){return!!e.expire&&new Date(e.expire).getTime()<=Date.now()}function N(e){if(!e)return"无过期";const t=new Date(e),n=t.getFullYear(),a=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0"),o=t.getTime()-Date.now();if(o>0){const e=Math.ceil(o/864e5);if(e<=30)return`${e}天后过期`}return`${n}-${a}-${s}`}function x(){a.value?uni.showModal({title:"确认退出",content:"确定要退出登录吗？",success:async({confirm:e})=>{e&&(i.value&&await _(),uni.removeStorageSync("token"),uni.removeStorageSync("username"),a.value=!1,o.value="",s.value="",v.value=[],h.value=null,uni.showToast({title:"已退出登录",icon:"success"}))}}):uni.navigateTo({url:"/pages/login/login"})}async function C(){r.value||(a.value?null!==h.value?i.value?await _():await async function(){const e=v.value[h.value];if(!e)return;if(!e.status||S(e))return void uni.showToast({title:"该节点不可用",icon:"none"});r.value=!0,u.value="连接中...",m.value="连接中...";try{await l.connect(e)}catch(t){r.value=!1,i.value=!1,u.value="连接失败",m.value="连接VPN",uni.showToast({title:t.message||"连接失败",icon:"none"})}}():uni.showToast({title:"请选择节点",icon:"none"}):uni.showToast({title:"请先登录",icon:"none"}))}async function _(){try{await l.disconnect()}catch(e){uni.showToast({title:e.message||"断开失败",icon:"none"})}}function B(e){const t=!(!e||!e.connected&&!e.isConnected);if(i.value=t,r.value=!1,u.value=e&&e.message?e.message:t?"已连接":"未连接",m.value=t?"断开连接":"连接VPN",t&&null!==h.value){const e=v.value[h.value];d.value=`${e.tag} · ${e.host}:${e.port}`,w&&(clearInterval(w),w=null);let t=0;p.value="连接时间: 00:00",w=setInterval((()=>{t++;const e=String(Math.floor(t/60)).padStart(2,"0"),n=String(t%60).padStart(2,"0");p.value=`连接时间: ${e}:${n}`}),1e3)}else w&&(clearInterval(w),w=null),d.value="--",p.value="--";e&&"error"===e.status&&e.message&&uni.showToast({title:e.message,icon:"none"})}return e.onMounted((async()=>{!function(){const e=uni.getStorageSync("token"),t=uni.getStorageSync("username");e&&t&&(o.value=e,s.value=t,a.value=!0)}(),await l.initialize(),l.onStatusUpdate(B),a.value&&k()})),e.onUnmounted((()=>{l.offStatusUpdate(),w&&(clearInterval(w),w=null)})),(t,n)=>{const o=(l=e.resolveDynamicComponent("uni-icons"),g=c,"string"==typeof l?g:l);var l,g;return e.openBlock(),e.createElementBlock("view",{class:"container"},[e.createElementVNode("view",{class:"header"},[e.createElementVNode("view",{class:"user-info"},[a.value?(e.openBlock(),e.createElementBlock("text",{key:0,class:"welcome-text"},"欢迎, "+e.toDisplayString(s.value),1)):(e.openBlock(),e.createElementBlock("text",{key:1,class:"welcome-text"},"请先登录")),e.createElementVNode("button",{class:"btn-auth",onClick:x},e.toDisplayString(a.value?"退出登录":"登录"),1)])]),e.createElementVNode("view",{class:"vpn-status-card"},[e.createElementVNode("view",{class:"status-header"},[e.createElementVNode("view",{class:e.normalizeClass(["status-indicator",V.value])},null,2),e.createElementVNode("text",{class:"status-text"},e.toDisplayString(u.value),1)]),e.createElementVNode("view",{class:"connection-info"},e.toDisplayString(d.value),1),e.createElementVNode("view",{class:"connection-time"},e.toDisplayString(p.value),1),e.createElementVNode("button",{class:e.normalizeClass(["btn-connect",{connecting:r.value}]),onClick:C,disabled:!a.value||0===v.value.length||null===h.value},e.toDisplayString(m.value),11,["disabled"])]),e.createElementVNode("view",{class:"section"},[e.createElementVNode("view",{class:"section-header"},[e.createElementVNode("text",{class:"section-title"},"节点列表"),e.createElementVNode("view",{class:"section-action",onClick:k},[e.createElementVNode("text",{class:"refresh-text"},"刷新"),e.createVNode(o,{type:"refresh",size:"16",color:"#4361ee"})])]),e.createElementVNode("view",{class:"nodes-stats"},[e.createElementVNode("text",{class:"stats-text"},"可用节点: "+e.toDisplayString(E.value.length)+"/"+e.toDisplayString(v.value.length),1)]),e.createElementVNode("scroll-view",{class:"node-list","scroll-y":""},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(v.value,((t,n)=>(e.openBlock(),e.createElementBlock("view",{key:t._id,class:e.normalizeClass(["node-item",{selected:h.value===n,offline:!t.status||S(t),"no-auth":!1}]),onClick:e=>function(e){const t=v.value[e];t&&(t.status&&!S(t)?(h.value=e,i.value&&(d.value=`${t.tag} · ${t.host}:${t.port}`)):uni.showToast({title:"该节点不可用",icon:"none"}))}(n)},[e.createElementVNode("view",{class:"node-info"},[e.createElementVNode("view",{class:"node-details"},[e.createElementVNode("text",{class:"node-name"},e.toDisplayString(t.tag),1),e.createElementVNode("view",{class:"node-meta"},[e.createElementVNode("text",{class:"node-location"},e.toDisplayString(t.host)+":"+e.toDisplayString(t.port),1),e.createElementVNode("text",{class:"node-expire"},e.toDisplayString(N(t.expire)),1)])])]),e.createElementVNode("view",{class:"node-status"},[e.createElementVNode("view",{class:"status-indicators"},[e.createElementVNode("text",{class:e.normalizeClass(t.status?"status-online":"status-offline")},e.toDisplayString(t.status?"在线":"离线"),3),(e.openBlock(),e.createElementBlock("text",{key:0,class:"status-noauth"},e.toDisplayString(t.account&&t.password?"需认证":"免认证"),1))]),h.value===n?(e.openBlock(),e.createElementBlock("view",{key:0,class:"selected-indicator"},[e.createVNode(o,{type:"checkmark",size:"16",color:"#4361ee"})])):e.createCommentVNode("",!0)])],10,["onClick"])))),128)),0===v.value.length?(e.openBlock(),e.createElementBlock("view",{key:0,class:"empty-state"},[e.createElementVNode("text",null,"暂无节点数据，请先登录或刷新")])):e.createCommentVNode("",!0)])]),e.createElementVNode("view",{class:"section tips-section"},[e.createElementVNode("view",{class:"section-header"},[e.createElementVNode("text",{class:"section-title"},"使用提示")]),e.createElementVNode("view",{class:"tips-content"},[e.createElementVNode("text",{class:"tip-item"},"• 节点“免认证”说明可直接连接（SOCKS5 无认证）"),e.createElementVNode("text",{class:"tip-item"},"• 首次连接会弹出 VPN 许可对话框，请允许"),e.createElementVNode("text",{class:"tip-item"},"• 连接后可切到后台，服务会常驻")])])])}}},[["__scopeId","data-v-753f7bb7"]]),u=i({__name:"login",setup(t){const n=e.ref("test_pan_1234"),a=e.ref("123456"),s=async()=>{var e;if(!n.value||!a.value)return uni.showToast({title:"请输入用户名和密码",icon:"none"});uni.showLoading({title:"登录中..."});try{const t=await uni.request({url:"http://124.223.21.69/api/users/login",method:"POST",data:{username:n.value,password:a.value},header:{"Content-Type":"application/json"}});if(200!==t.statusCode||!t.data)throw new Error((null==(e=t.data)?void 0:e.message)||"登录失败");{const e=t.data.token||t.data.accessToken;if(!e)throw new Error("未返回 token");uni.setStorageSync("token",e),uni.setStorageSync("username",n.value),uni.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{uni.reLaunch({url:"/pages/index/index"})}),500)}}catch(t){uni.showToast({title:t.message||"登录失败",icon:"none"})}finally{uni.hideLoading()}};return(t,o)=>(e.openBlock(),e.createElementBlock("view",{class:"login-container"},[e.createElementVNode("view",{class:"login-header"},[e.createElementVNode("view",{class:"title-container"},[e.createElementVNode("image",{class:"title-icon",src:"/static/icon.ico",mode:"aspectFit"}),e.createElementVNode("text",{class:"login-title"},"e加速")]),e.createElementVNode("text",{class:"login-subtitle"},"请登录您的VPN账户")]),e.createElementVNode("view",{class:"login-form"},[e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"用户名"),e.withDirectives(e.createElementVNode("input",{class:"input-field",type:"text","onUpdate:modelValue":o[0]||(o[0]=e=>n.value=e),placeholder:"请输入用户名"},null,512),[[e.vModelText,n.value]])]),e.createElementVNode("view",{class:"input-group"},[e.createElementVNode("text",{class:"input-label"},"密码"),e.withDirectives(e.createElementVNode("input",{class:"input-field",type:"password","onUpdate:modelValue":o[1]||(o[1]=e=>a.value=e),placeholder:"请输入密码"},null,512),[[e.vModelText,a.value]])]),e.createElementVNode("button",{class:"btn-login",onClick:s},"登录"),e.createElementVNode("view",{class:"login-tips"})])]))}},[["__scopeId","data-v-3697e022"]]);__definePage("pages/index/index",r),__definePage("pages/login/login",u);const d={__name:"App",setup:e=>(o((()=>{n("log","at App.vue:6","App Launch");uni.getStorageSync("token")&&uni.reLaunch({url:"/pages/index/index"})})),n("log","at App.vue:18","App Show"),s((()=>{n("log","at App.vue:22","App Hide")})),()=>{})};const{app:p,Vuex:m,Pinia:v}={app:e.createVueApp(d)};uni.Vuex=m,uni.Pinia=v,p.provide("__globalStyles",__uniConfig.styles),p._component.mpType="app",p._component.render=()=>{},p.mount("#app")}(Vue);
